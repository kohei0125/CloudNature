# Pricing Engine 高額見積もり改修レビュー

> 作成日: 2026-02-27

## 検証目的

チラシ検索サイト（新聞販売店向け）の見積もりが ¥10,615,000（hybrid）となり、実際の相場（300万〜500万円）から大幅に乖離する問題を是正する。Pricing Engine の構造的な乗数過大を修正する。

## 対象範囲

- `backend/app/core/pricing_engine.py` — 乗数テーブル・機能数ディスカウント
- `backend/tests/test_pricing_engine.py` — 期待値更新・新規テスト追加
- `backend/docs/estimate_logic.md` — 仕様書更新

## 確認項目

- [ ] 改修A: `_USER_SCALE` 乗数引き下げ
- [ ] 改修B: `_MAX_MULTIPLIER` 4.0 → 2.5
- [ ] 改修C: `_DEVICE` / `_TARGET` 乗数引き下げ + `"client"` dead code 削除
- [ ] 改修D: `_feature_count_discount` 関数追加 + `calculate_estimate()` への適用
- [ ] 既存テスト4件の期待値更新
- [ ] 新規テスト7件追加
- [ ] 全テスト通過
- [ ] estimate_logic.md 更新

## Codex レビュー結果

- **[P1] `"client"` キー削除の回帰リスク** — `backend/app/schemas/step_options.py` の `DEPLOYMENT_TARGETS` にまだ `"client"` が存在。単純削除すると `.get(..., 1.0)` フォールバックで見積もりが過小になる。
  - **対応:** `"client": 1.15` をレガシー互換として `_TARGET` に残した。

## 対応状況

- [x] 改修A: `_USER_SCALE` 乗数引き下げ
- [x] 改修B: `_MAX_MULTIPLIER` 4.0 → 2.5
- [x] 改修C: `_DEVICE` / `_TARGET` 乗数引き下げ（`"client"` はレガシー互換で残存）
- [x] 改修D: `_feature_count_discount` 関数追加 + `calculate_estimate()` への適用
- [x] 既存テスト4件の期待値更新
- [x] 新規テスト7件追加
- [x] 全65テスト通過
- [x] estimate_logic.md 更新
- [x] Codex レビュー実施・指摘対応済み

---

## シミュレーション結果（10ケース）

改修後のpricing engineで10パターンの見積もりをシミュレーションした結果。

### 結果一覧

| # | 案件 | 機能数 | Standard | Hybrid | 想定相場 | 判定 |
|---|------|-----:|--------:|------:|---------|:---:|
| 1 | 競合サイト価格監視ツール | 3 | ¥1,749,000 | ¥1,049,000 | 50万〜150万 | △ |
| 2 | 既存サイト改修・スパム対策 | 2 | ¥1,528,000 | ¥917,000 | 20万〜80万 | × |
| 3 | 店舗のWeb予約システム | 4 | ¥3,900,000 | ¥2,340,000 | 150万〜400万 | ○ |
| 4 | 社内AIチャットボット（PoC） | 3 | ¥2,338,000 | ¥1,402,000 | 200万〜500万 | ○ |
| 5 | 採用業務の自動化連携 | 4 | ¥2,724,000 | ¥1,633,000 | 150万〜400万 | ○ |
| 6 | BtoBマッチングプラットフォーム | 7 | ¥10,895,000 | ¥6,538,000 | 500万〜1200万 | ○ |
| 7 | 画像生成AI SaaS | 3 | ¥4,732,000 | ¥2,840,000 | 400万〜800万 | ○ |
| 8 | 不動産業界向け業務支援SaaS | 6 | ¥8,857,000 | ¥5,315,000 | 800万〜2000万 | ○ |
| 9 | 地域イベントポータルサイト | 4 | ¥4,188,000 | ¥2,513,000 | 150万〜400万 | △ |
| 10 | オンプレ→クラウド移行 | 5 | ¥6,867,000 | ¥4,120,000 | 400万〜800万 | ○ |

**判定基準:** ○=相場範囲内 △=やや外れるが許容範囲 ×=大幅乖離

### ケース別分析

#### ケース1: 競合サイト価格監視ツール（△ hybrid ¥1,049,000 / 相場50万〜150万）

- 乗数: asap(1.15) × sole_proprietor(0.85) = 0.98（ほぼ等倍）
- 3機能（データ管理、通知、帳票出力）× 0.95ディスカウント
- **分析:** 機能単価は妥当だが、「スクレイピング+LINE通知」程度の軽量ツールとしては高め。ただしカスタム開発として3機能を新規構築する場合100万前後は妥当とも言える。この案件は既存SaaS活用（Make, Zapier等）を推奨するレベルで、フルスクラッチ見積もりの下限に近い。

#### ケース2: 既存サイト改修・スパム対策（× hybrid ¥917,000 / 相場20万〜80万）

- 乗数: both(1.15) × client_b2c(1.3) × enhancement(0.7) × asap(1.15) = 1.20
- **分析:** reCAPTCHA導入+CSS修正はプラグイン設定・軽微なCSS修正レベルの作業であり、そもそもカスタム開発見積もりエンジンの対象範囲外。AI動的質問がWordPress改修として適切な最小機能を提案すれば改善するが、エンジン側の問題ではない。

#### ケース3: 店舗のWeb予約システム（○ hybrid ¥2,340,000 / 相場150万〜400万）

- 乗数: both(1.15) × client_b2c(1.3) × 3months(1.05) × sole_proprietor(0.85) = 1.33
- 4機能（予約カレンダー、CRM、通知、データ管理）× 0.95ディスカウント
- **分析:** 相場範囲内。サロン予約＋顧客管理の新規構築として妥当。

#### ケース4: 社内AIチャットボット PoC（○ hybrid ¥1,402,000 / 相場200万〜500万）

- 乗数: 21-50人(1.15) × 3months(1.05) = 1.21
- 3機能 × 0.95ディスカウント
- **分析:** PoC段階として妥当。全社展開フェーズは別見積もりとなる。

#### ケース5: 採用業務の自動化連携（○ hybrid ¥1,633,000 / 相場150万〜400万）

- 乗数: 3months(1.05) = 1.05（ほぼ等倍）
- 4機能 × 0.95ディスカウント
- **分析:** 相場範囲内。複数媒体のスクレイピング＋Kintone/Slack連携として妥当。

#### ケース6: BtoBマッチングプラットフォーム（○ hybrid ¥6,538,000 / 相場500万〜1200万）

- 乗数: 101+(1.5) × both(1.15) × client_b2b(1.15) = 1.98
- 7機能（商品管理、在庫、検索、CRM、通知、EC連携、請求管理）× 0.85ディスカウント（→複雑カテゴリ1個なので抑制なし）
- **分析:** 相場範囲内。決済・EC連携を含む本格的なマッチングサイトとして妥当。

#### ケース7: 画像生成AI SaaS（○ hybrid ¥2,840,000 / 相場400万〜800万）

- 乗数: 101+(1.5) × both(1.15) × client_b2c(1.3) × 3months(1.05) = 2.35
- 3機能（基本管理、ダッシュボード、検索）× 0.95ディスカウント
- **分析:** 相場下限寄り。実運用ではAIが「決済連携」「外部API連携(複雑)」等の機能をstep_8に追加提案するため、実際の見積もりは400万〜600万になる見込み。

#### ケース8: 不動産業界向け業務支援SaaS（○ hybrid ¥5,315,000 / 相場800万〜2000万）

- 乗数: 101+(1.5) × both(1.15) × client_b2b(1.15) = 1.98
- 6機能 × 0.90ディスカウント
- **分析:** 相場下限寄りだが、step_8にマルチテナント対応・契約書自動生成等の複雑機能が入ればさらに上がる。要件定義フェーズの入り口としての概算には適切。

#### ケース9: 地域イベントポータルサイト（△ hybrid ¥2,513,000 / 相場150万〜400万）

- 乗数: 6-20人(1.05) × both(1.15) × client_b2c(1.3) = 1.57
- 4機能（データ管理、検索、承認WF、通知）× 0.95ディスカウント
- **分析:** 承認ワークフローの単価（¥929,000 hybrid）が全体を押し上げている。CMSベースの構築なら安くなるが、フルスクラッチの承認フロー込みなら妥当とも言える。CMS活用（WordPress+プラグイン等）の提案がdiscussion_agendaに入ることで実態に近づく。

#### ケース10: オンプレ→クラウド移行（○ hybrid ¥4,120,000 / 相場400万〜800万）

- 乗数: 21-50人(1.15) × both(1.15) × migration(1.2) = 1.59
- 5機能（請求管理、受発注、帳票、データ移行、ダッシュボード）× 0.90ディスカウント
- **分析:** 相場範囲内。10年稼働のAccessシステムのWeb化＋データ移行として妥当。

### 総合評価

- **10件中7件が相場範囲内（○）、2件がやや外れ（△）、1件が大幅乖離（×）**
- △のケースは「軽量ツール」「CMS活用案件」であり、フルスクラッチ見積もりとしては許容範囲
- ×のケース2はWordPressプラグイン設定レベルの軽微作業で、そもそもカスタム開発見積もりの対象外
- 改修前の乗数構造（上限4.0、ユーザー規模2.5等）ではケース6が ¥16,000,000超、ケース8が ¥14,000,000超になっていた計算で、大幅に改善された

---

## シミュレーション結果 第2弾（エッジケース10件）

超短文・超抽象的な依頼、iPaaS/CMS活用すべき軽微案件、夢語り系の大風呂敷案件など、実際の問い合わせで頻出するエッジケースを検証。

### 結果一覧

| # | 案件 | 機能数 | Standard | Hybrid | 想定相場 | 判定 |
|---|------|-----:|--------:|------:|---------|:---:|
| 1 | メルカリみたいなサイト | 7 | ¥10,849,000 | ¥6,510,000 | MVP 500万〜 / フル 1000万〜3000万 | ○ |
| 2 | フォーム→CRM自動連携 | 2 | ¥1,021,000 | ¥612,000 | 10万〜50万（iPaaS活用） | × |
| 3 | 高級造園業 顧客ポータル | 4 | ¥4,263,000 | ¥2,559,000 | 300万〜700万 | ○ |
| 4 | 自社データAIアシスタント | 4 | ¥3,706,000 | ¥2,224,000 | 500万〜1500万 | △ |
| 5 | パフォーマンス改善 | 1 | ¥926,000 | ¥556,000 | 5万〜30万（調査フェーズ） | × |
| 6 | 出欠・投票システム | 4 | ¥4,073,000 | ¥2,444,000 | 150万〜400万 | △ |
| 7 | アパレル ヘッドレスEC | 6 | ¥8,367,000 | ¥5,021,000 | 500万〜1500万 | ○ |
| 8 | 公衆トイレレビューアプリ | 4 | ¥6,814,000 | ¥4,088,000 | 200万〜500万 | × |
| 9 | 歯科医院シフト管理 | 4 | ¥3,677,000 | ¥2,207,000 | 200万〜500万 | ○ |
| 10 | 漁業DXプラットフォーム | 6 | ¥10,472,000 | ¥6,284,000 | MVP 300万〜800万 / フル 2000万〜 | ○ |

**判定基準:** ○=相場範囲内 △=やや外れるが許容範囲 ×=構造的に対象外

### ケース別分析

#### ケース1: メルカリみたいなサイト（○ hybrid ¥6,510,000 / MVP500万〜）

- 乗数: 101+(1.5) × both(1.15) × client_b2c(1.3) = 2.24
- 7機能 × 0.85ディスカウント → 複雑カテゴリ1個で抑制なし
- **分析:** MVP構築費として妥当な範囲。超短文で曖昧な依頼にも関わらず「step_4が曖昧」のヒントが正しく検出されている。実運用では「決済連携」や「承認ワークフロー（エスクロー）」がstep_8に追加されさらに上がる。discussion_agendaで「メルカリ規模のフル実装は数千万〜数億。まずMVP定義を推奨」と案内すべき案件。

#### ケース2: フォーム→CRM自動連携（× hybrid ¥612,000 / 相場10万〜50万）

- 乗数: enhancement(0.7) × asap(1.15) = 0.80
- **分析:** Zapier/Make等のiPaaS活用で1日〜数日の作業。カスタム開発見積もりエンジンの対象外。前回ケース2（WordPress改修）と同様、本エンジンの構造的限界であり、discussion_agendaで「iPaaS活用を推奨（10万〜30万）」と案内することでカバーする。

#### ケース3: 高級造園業 顧客ポータル（○ hybrid ¥2,559,000 / 相場300万〜700万）

- 乗数: 6-20(1.05) × both(1.15) × client_b2b(1.15) × 3months(1.05) = 1.46
- 4機能 × 0.95ディスカウント
- **分析:** 相場範囲内。大容量ファイル管理+チャット+セキュアなポータルの構築として妥当。セキュリティヒントも正しく検出。

#### ケース4: 自社データAIアシスタント（△ hybrid ¥2,224,000 / 相場500万〜1500万）

- 乗数: 51-100(1.3) = 1.30（他は全てデフォルト）
- 4機能 × 0.95ディスカウント
- **分析:** 相場より安い。原因はstep_8の機能選択が「知識ベース＝AIチャットボット」1つ＋汎用3機能しかないため。実運用ではAI動的質問が「RAGパイプライン構築」「AD連携認証」「ドキュメント権限管理」等の複雑機能を提案し、5〜7機能で500万〜800万程度になる見込み。閉域網・AD連携のインフラ構築費はエンジンのスコープ外でdiscussion_agendaに含まれるべき。

#### ケース5: パフォーマンス改善（× hybrid ¥556,000 / 相場5万〜30万）

- 乗数: both(1.15) × client_b2c(1.3) × enhancement(0.7) × asap(1.15) = 1.20
- 1機能のみ
- **分析:** 「画像最適化＋CDN設定」程度の調査・改善作業であり、カスタム開発見積もりの対象外。ケース2同様、discussion_agendaで「まずパフォーマンス調査（5万〜10万）を推奨」とガイドすべき。3つのヒント（曖昧・急ぎ・予算超過）が全て正しく検出されている点は良好。

#### ケース6: 出欠・投票システム（△ hybrid ¥2,444,000 / 相場150万〜400万）

- 乗数: 51-100(1.3) × both(1.15) × 3months(1.05) = 1.57
- 4機能 × 0.95ディスカウント
- **分析:** 相場上限をやや超過。51-100人の乗数(1.3)が影響しているが、QRコードチェックイン＋リアルタイム投票＋管理ダッシュボードのフルスクラッチ構築としては妥当とも言える。ノーコード（Glide等）の代替案をdiscussion_agendaで提案すべき案件。

#### ケース7: アパレル ヘッドレスEC（○ hybrid ¥5,021,000 / 相場500万〜1500万）

- 乗数: 101+(1.5) × both(1.15) × client_b2c(1.3) × enhancement(0.7) = 1.57
- 6機能（EC連携×2、在庫管理、検索、ダッシュボード）× 0.90ディスカウント
- **分析:** 相場範囲内。Shopify Storefront API + Algolia + スマレジAPI + Instagram連携のヘッドレス構築として妥当。enhancement(0.7)が適切に効いて、新規構築より3割引の計算。

#### ケース8: 公衆トイレレビューアプリ（× hybrid ¥4,088,000 / 相場200万〜500万）

- 乗数: 101+(1.5) × mobile_app(1.5) × client_b2c(1.3) × sole_proprietor(0.85) = 2.49
- 4機能 × 0.95ディスカウント
- **分析:** mobile_app(1.5)の乗数が大きく影響。ネイティブアプリ開発（iOS/Android両対応）なら400万は下限寄りだが、PWAで構築すればweb_app(1.0)となり¥2,700,000程度に収まる。本エンジンの想定通り、モバイルアプリはWeb比1.5倍。discussion_agendaで「PWA vs ネイティブアプリの選択」を議題にすべき。ただし、実際にはstep_6の選択はユーザーが行うので、web_appを選べば適正範囲。mobile_app選択時の金額としては妥当。

#### ケース9: 歯科医院シフト管理（○ hybrid ¥2,207,000 / 相場200万〜500万）

- 乗数: 6-20(1.05) × both(1.15) × 3months(1.05) = 1.27
- healthcare業種補正 ×1.15
- 4機能 × 0.95ディスカウント
- **分析:** 相場範囲内。ロール別シフト＋複雑な時給計算＋CSV出力の構築として妥当。healthcare業種ヒントが正しく検出されている。

#### ケース10: 漁業DXプラットフォーム（○ hybrid ¥6,284,000 / MVP 300万〜800万）

- 乗数: 101+(1.5) × both(1.15) × client_b2c(1.3) × asap(1.15) = 2.58 → **2.5倍上限適用**
- 6機能 × 0.90ディスカウント
- **分析:** 超抽象的な「夢語り系」依頼だが、step_8に入れた6機能でのMVP構築費として妥当。「仕様書なし・来月開始」に対し「納期急ぎヒント」が正しく検出。discussion_agendaで「まずMVP検証フェーズ（特定漁港×特定飲食店のテスト販売）を提案。オークション・AI鮮度判定・物流APIは第2フェーズ以降」と案内すべき。

### 総合評価

- **10件中5件が相場範囲内（○）、2件がやや外れ（△）、3件が構造的に対象外（×）**
- ×のケース（2, 5）は「iPaaS/調査フェーズで完結する軽微作業」であり、フルスクラッチ前提の本エンジンの設計上の対象外
- ×のケース8はmobile_app乗数1.5が原因だが、ネイティブアプリとして見れば妥当。PWA構築ならweb_appで適正範囲
- △のケース4はstep_8の機能選択不足が原因（AI動的質問で改善見込み）
- △のケース6はフルスクラッチとしては妥当だが、ノーコード代替の提案が有効

### エッジケース対応における本エンジンの強みと限界

**強み:**
- 超短文・抽象依頼でも `step_4が曖昧` ヒントが正しく検出される
- 急ぎ案件で `MVP範囲の策定を推奨` が自動提示される
- healthcare等の法規制業種で適切な警告が出る
- 乗数上限2.5により、条件が重なっても極端な高額にならない

**限界（エンジン設計上の対象外）:**
- iPaaS/ノーコードで完結する自動化・連携作業（10万〜50万規模）
- パフォーマンス調査・改善（5万〜30万規模）
- WordPress等CMS設定レベルの軽微作業

→ これらはdiscussion_agendaやAIテキスト生成側で「本案件はカスタム開発ではなく〇〇ツールの活用を推奨します」と案内する設計で対応すべき。pricing engineの改修スコープ外。

---

## E2Eテスト結果（実際のAPIフロー、AI動的質問含む）

ローカルDocker環境（改修済みコード）でAPIフロー全体を通したテスト。Step 7でGemini AIが提案した機能を全選択した場合の実際の見積もり金額。

### 結果一覧

| # | 案件 | AI提案機能数 | Standard | Hybrid | 想定相場 | 判定 |
|---|------|----------:|--------:|------:|---------|:---:|
| 1 | 競合サイト価格監視ツール | 6 | ¥4,196,000 | ¥2,517,000 | 50万〜150万 | × |
| 2 | 既存サイト改修・スパム対策 | 6 | ¥4,333,000 | ¥2,600,000 | 20万〜80万 | × |
| 3 | 店舗のWeb予約システム | 7 | ¥6,193,000 | ¥3,715,000 | 150万〜400万 | △ |
| 4 | 社内AIチャットボット（PoC） | 7 | ¥8,403,000 | ¥5,042,000 | 200万〜500万 | × |
| 5 | 採用業務の自動化連携 | 7 | ¥5,669,000 | ¥3,400,000 | 150万〜400万 | △ |
| 6 | BtoBマッチングPF | 7 | ¥11,998,000 | ¥7,199,000 | 500万〜1200万 | ○ |
| 7 | 画像生成AI SaaS | 7 | ¥14,019,000 | ¥8,412,000 | 400万〜800万 | × |
| 8 | 不動産業務支援SaaS | 7 | ¥9,988,000 | ¥5,993,000 | 800万〜2000万 | ○ |
| 9 | 地域イベントポータル | 6 | ¥7,010,000 | ¥4,205,000 | 150万〜400万 | × |
| 10 | オンプレ→クラウド移行 | 7 | ¥8,872,000 | ¥5,323,000 | 400万〜800万 | △ |
| 11 | メルカリみたいなサイト | 7 | ¥10,630,000 | ¥6,379,000 | MVP500万〜 | ○ |
| 12 | フォーム→CRM連携 | 6 | ¥3,539,000 | ¥2,124,000 | 10万〜50万（iPaaS） | × |
| 13 | 高級造園業 顧客ポータル | 6 | ¥6,257,000 | ¥3,754,000 | 300万〜700万 | ○ |
| 14 | 自社データAIアシスタント | 7 | ¥7,830,000 | ¥4,698,000 | 500万〜1500万 | ○ |
| 15 | パフォーマンス改善 | 6 | ¥5,333,000 | ¥3,200,000 | 5万〜30万（調査） | × |
| 16 | 出欠・投票システム | 7 | ¥6,721,000 | ¥4,034,000 | 150万〜400万 | × |
| 17 | アパレル ヘッドレスEC | 7 | ¥11,302,000 | ¥6,782,000 | 500万〜1500万 | ○ |
| 18 | 公衆トイレレビューアプリ | 6 | ¥9,381,000 | ¥5,628,000 | 200万〜500万 | × |
| 19 | 歯科医院シフト管理 | 7 | ¥7,244,000 | ¥4,347,000 | 200万〜500万 | △ |
| 20 | 漁業DXプラットフォーム | 7 | ¥13,731,000 | ¥8,238,000 | MVP300万〜800万 | × |

**判定:** ○=相場範囲内(6件) △=やや超過だが許容(4件) ×=大幅乖離(10件)

### AI提案機能の内訳

| # | AI提案機能 |
|---|---------|
| 1 | 競合商品情報設定, 競合価格自動収集, 価格変動履歴管理, 価格変動ダッシュボード, CSV/スプレッドシート出力, LINE通知連携 |
| 2 | フォームスパム対策, アクセス元制限設定, 問い合わせデータ管理, 通知設定, 履歴検索, 件数レポート |
| 3 | 予約カレンダー管理, オンライン予約, 顧客情報・来店履歴, リマインド通知, スタッフスケジュール, 売上ダッシュボード, 施術メニュー設定 |
| 4 | AIチャットbot画面, FAQ・マニュアル知識DB, 文書インポート・自動解析, AI学習データ管理, 回答評価フィードバック, 未解決質問管理, 利用状況分析DB |
| 5 | 求人媒体データ自動抽出, Kintone自動登録, Slack通知, スクレイピング設定管理, 応募者一覧・検索, 抽出履歴・エラーログ, 稼働状況ダッシュボード |
| 6 | 出品・商品情報管理, 注文・受発注管理, 在庫リアルタイム表示, BtoB決済・手数料計算, メッセージ, 検索・絞り込み, 運営管理ダッシュボード |
| 7 | AI画像生成インターフェース, 会員登録・プラン管理, Stripe決済連携, マイギャラリー, 履歴・クレジット管理, ユーザーダッシュボード, 運営管理画面 |
| 8 | 間取り図作成エディタ, 契約書自動生成, 顧客・案件ステータス管理, 物件情報マスタ, マルチテナント対応, 電子署名連携, 売上・手数料計算レポート |
| 9 | イベント投稿フォーム, 承認フロー, カレンダー検索, CMS, おすすめ表示, アカウント管理 |
| 10 | 見積書作成, 受注入力, 請求書発行, 販売実績ダッシュボード, 顧客・取引先マスタ, データ移行ツール, 書類検索 |
| 11 | 商品出品・管理, 検索・詳細表示, セキュア決済, ユーザー間メッセージ, 評価・レビュー, ダッシュボード, プッシュ通知 |
| 12 | HubSpot連携, Chatwork通知, フォーム連携設定, 通知メッセージ設定, 連携処理ログ, 連携状況ダッシュボード |
| 13 | 顧客専用ダッシュボード, 大容量ファイル閲覧, 施工進捗写真共有, チャット機能, 施工進捗状況, 進捗更新通知 |
| 14 | AIチャット質疑応答, ドキュメントデータ管理, ベクトルDB・AI連携, AD連携・権限, 引用元表示, 利用状況ダッシュボード, 監査ログ |
| 15 | 画像自動最適化, キャッシュ設定, サイト内検索, 通知機能, アクセス解析ダッシュボード, お問い合わせフォーム管理 |
| 16 | 案内自動通知, 出欠登録, QRコードチェックイン, リアルタイム投票, 集計ダッシュボード, 会員情報マスタ, 議案登録 |
| 17 | ShopifyヘッドレスAPI, Algolia検索, スマレジPOS連携, Instagram連携, SSG/ISR商品ページ, カート・注文フロー, 顧客マイページ |
| 18 | トイレマップ表示・検索, 写真・評価投稿, 詳細・評価表示, GPS連携, 絞り込み, 投稿履歴管理 |
| 19 | ロール別シフト作成, 希望シフト提出, 複雑手当自動計算, 勤怠実績データ, 給与CSV出力, スタッフ情報管理, シフト承認WF |
| 20 | 漁師向け出品, オークション入札, アカウント管理, 決済連携, メッセージ・通知, 配送情報管理, 市場相場ダッシュボード |

### 根本原因分析

**シミュレーション（手動step_8選択）では20件中12件が相場内だったが、E2Eテスト（AI自動提案）では6件に減少。** 主因は以下の2つ:

#### 原因1: AIが常に6〜7機能を提案する（過剰提案）

AI動的質問プロンプト（`dynamic_questions.txt`）は5〜7機能を提案するよう設計されている。しかし:
- **軽微案件**（スパム対策、パフォーマンス改善）でも6機能を提案 → 本来1〜2機能で済む作業が6機能分の費用に
- **PoC段階**（AIチャットbot）でも7機能フル提案 → MVP段階では3〜4機能が妥当

#### 原因2: 機能カテゴリの割り当てが重い

AIが提案する機能名は具体的で良いが、それがpricing engineの17カテゴリにマッピングされる際、LLMカテゴリ割り当て（`step_8_categories`）が高単価カテゴリに偏る傾向がある:
- 「AI画像生成インターフェース」→ AIチャットボット(115万)
- 「Stripe決済連携」→ 決済連携(92.5万)
- 「マルチテナント対応」→ マルチテナント(97.5万)

これらの高単価カテゴリが複数重なると金額が急増する。

### 改善提案と対応状況

| 対策 | 効果 | 難易度 | 状況 |
|------|------|-------|------|
| **A. AI動的質問プロンプトの機能提案数抑制** | 軽微案件・PoC案件で過剰提案を抑制 | 低 | ✅ 実施済み (`ca43a5e`) |
| **B. 機能数ディスカウントの強化（7件→0.78）** | 多機能案件の金額を抑制 | 低 | ✅ 実施済み (`2233478`) |
| **C. AIに「PoC/MVP」フラグを判定させ、段階に応じた機能数の制限を行う** | PoC案件の過剰見積もりを防止 | 中 | ✅ 改善Aに統合（プロンプトにPoC/MVP検出ルール追加済み） |
| **D. 「カスタム開発対象外」判定ロジックの追加** | iPaaS/CMS案件を自動的に低コスト提案に振り分け | 高 | ✅ 改善Aに統合（プロンプトに軽微作業検出ルール追加済み） |

#### 改善A 詳細（`dynamic_questions.txt`）
- デフォルト機能提案数: 5〜7個 → **4〜6個**
- enhancement時: **3〜4個** に制限
- PoC/MVP/スモールスタート検出: challenges内キーワードから自動判定、**最大3〜4個** に制限
- 軽微作業検出: スパム対策・CMS設定等を検出、**2〜3個** に制限

#### 改善B 詳細（`pricing_engine.py`）
- 3〜4機能: 0.95 → **0.93**
- 5〜6機能: 0.90 → **0.85**
- 7機能以上: 0.85 → **0.78**
- 複雑カテゴリ抑制下限: 0.90維持
